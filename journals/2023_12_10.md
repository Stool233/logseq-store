- [[_Thread_local]]
	- `_Thread_local` 是 C11 标准中引入的一个存储类说明符，用于声明线程局部存储（Thread-Local Storage，简称 TLS）。
		- 当一个变量被声明为 `_Thread_local`，每个线程都会有该变量的独立副本。
		- 这意味着，即使多个线程执行相同的代码，它们访问的 `_Thread_local` 变量也是各自独立的，互不影响。
	- 代码片段中：
		- ```c
		  _Thread_local sqlite3 *DbHandle = NULL; /* Per-thread sqlite handle. */
		  ```
		- 这里声明了一个指向 `sqlite3` 类型的指针 `DbHandle`，并且这个指针是线程局部的。
		- 这意味着每个线程都会有自己的 `DbHandle` 指针副本，它们指向各自线程专有的 `sqlite3` 数据库连接句柄。
		- 初始化为 `NULL` 表示在每个线程中，这个指针最初都不指向任何 `sqlite3` 对象。
	- 使用线程局部存储的好处是可以避免在多线程环境下对全局或静态变量的竞争条件（race conditions）和同步问题。
		- 每个线程有自己的变量副本，因此不需要额外的同步机制来保护这个变量的访问，从而可以提高多线程程序的性能。
	- 需要注意的是，不是所有的编译器都支持 `_Thread_local` 关键字。
		- 在一些编译器中，可能需要使用 `__thread`（在 GCC 中）或 `thread_local`（在 C++11 或更高版本中）来声明线程局部存储。
		- 而 `_Thread_local` 是 C11 标准中定义的，因此如果你的编译器支持 C11，那么应该可以使用 `_Thread_local`。
	- 当你在代码中使用 `_Thread_local`（或其等价的 `__thread` 或 `thread_local`）声明一个变量时，编译器和运行时系统会合作确保每个线程都有其自己的变量实例。这涉及到几个底层的机制：
		- **1. 线程局部存储区域分配**：
			- 编译器会为每个线程局部变量在每个线程的存储空间中分配一个独立的位置。
			- 通常，这是在操作系统为每个线程创建的线程栈之外的特定区域，有时被称为线程局部存储区（TLS区）。
		- **2. 初始化**：
			- 对于有初始化值的线程局部变量，编译器会生成代码来在线程开始时初始化这些变量。
			- 如果是静态初始化（如初始化为 `NULL` 或常量），这通常只需要在创建线程时复制数据。
			- 对于动态初始化（如构造函数调用），可能需要在线程开始运行时执行更复杂的代码。
		- **3. 访问转换**：
			- 当代码试图访问一个线程局部变量时，编译器会生成额外的指令来确保访问的是当前线程的变量副本。
			- 这通常涉及到读取一个特定的寄存器或使用特定的指令，这些寄存器或指令直接指向当前线程的TLS区。
		- **4. 动态分配**：
			- 如果线程是在程序运行时动态创建的，运行时系统必须确保为新线程分配TLS区，并初始化其中的线程局部变量。
		- **5. 销毁处理**：
			- 当线程结束时，运行时系统需要调用线程局部变量的析构函数（如果有的话），并释放其占用的资源。
		- **6. 链接器支持**：
			- 链接器需要支持TLS变量，因为它们可能跨多个编译单元。
			- 链接器必须确保所有对TLS变量的引用都正确地解析到每个线程的TLS区。
	- 在x86架构上，线程局部存储（TLS）通常是通过使用特殊的段寄存器来实现的，这些寄存器可以直接访问当前线程的局部存储区域。
		- 在32位x86架构中，这通常是`fs`段寄存器，而在64位x86架构（x86-64）中，通常是`gs`段寄存器。
		- 以下是实现的一些细节：
			- 1. 段寄存器和线程局部存储
				- 每个线程都有一个指向其TLS区域的指针，这个指针存储在一个段寄存器中。
				- 在x86架构上，操作系统在创建线程时会设置这个寄存器，以便它指向线程的TLS区域。
			- 2. 访问TLS变量
				- 当程序需要访问一个TLS变量时，编译器会生成特殊的指令，这些指令使用`fs`或`gs`段寄存器作为基址来访问TLS区域。
					- 例如，在32位x86上，编译器可能生成类似`mov eax, fs:[0x10]`的指令来访问TLS变量。
			- 3. 初始化和销毁
				- 在程序启动和每个线程创建时，运行时系统负责初始化TLS区域。这包括为每个TLS变量分配空间，并根据需要进行初始化。当线程退出时，运行时系统也负责调用任何TLS变量的析构函数，并清理TLS区域。
				-
-