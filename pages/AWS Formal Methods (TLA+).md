- **TAG:** [[TLA+]] [[Computer Science]]
- 这篇关于AWS形式化方法的实践（TLA+的实践）的文章的整理
	- https://lamport.azurewebsites.net/tla/formal-methods-amazon.pdf
- 文章摘要大纲（以及遇到的问题简述）
	- 从2011年开始，AWS使用形式化描述和模型检查（formal specification and model checking），去解决核心系统的复杂设计问题。
	- AWS在向客户提供上手简单的使用接口的背后，是一系列复杂的[[分布式系统]]在提供基础支撑。
		- 这些复杂的分布式系统有严苛的高可用与性能诉求，以及无情的业务增长带来的性能扩展性问题。
		- 为了达成这样的前所未有的目标，简单复用学术界/业界已经证明可靠的[[分布式算法]]（[[容错]]、[[一致性]]等类型），难以完成挑战，有时不得已需要修改这些算法，甚至发明自己的新的分布式算法。
			- 分布式算法难以避免的复杂度 增大了 人为的设计失误、代码编写失误、运维失误 出现的可能性
				- 这会导致严重的数据丢失或损坏，或违反我们的客户所依赖的其他接口契约（SLA）
			- 所以需要有手段保证核心系统的极度的可靠性。
				- 我们发现工业上的标准验证技术是必要的，但不是充分的。
					- 我们经常使用深度设计评审、[[代码评审]]、[[静态代码分析]]、[[压力测试]]和[[故障注入测试]]，但仍然发现在复杂的并发容错系统中隐藏着微妙的bug。
					- 一个原因是，在每秒数百万次请求规模的系统中，在估计所谓“极其罕见”的事件组合的真实[[概率]]方面，人类的直觉表现很差。
- 关键的见解（key insights）
	- 形式化方法在系统设计中找到我们所知道的其他技术无法找到的bug。
	- 形式化方法对于主流软件开发来说是出人意料的可行的，并且具备可观的投入产出比。
	- 在亚马逊，形式化方法通常被用于设计复杂的现实世界软件，包括公共云服务。
- 关于形式化方法（[[Formal Methods]]）的一些概述，以及AWS在实践上的整体感受
	- 人的不可靠性意味着一些更微妙、更危险的bug被证明是设计中的错误
		- 代码忠实地实现了预期的设计，但设计未能正确地处理特定的“罕见”场景
		- 我们发现，测试代码作为发现设计中细微错误的方法是不充分的，因为代码的可达状态的数量是天文数字。
			- 所以我们寻找更好的方法。
	- 更精确的设计（Precise Design）
		- 精确设计（precise design）的两个主要的好处
			- 作者被迫更清晰的思考，帮助消除“似是而非”的描述
			- 并且可以使用工具来检查设计中的错误，即使是还在写设计的过程中。
		- 与此相反，传统的设计文档 由 散文式的描述、静态的架构图、和不可测试的伪代码编写组成。
			- 这每一种都离“精确”很远，它们通常是不明确的，或缺少一些关键的描述(例如部分故障或并发粒度下的表现)。
			- 另一方面，最终的可执行代码是明确的，但包含大量的细节。我们必须在大量的代码中捕捉到设计的精髓。
		- 我们对精确设计（precise design）工具的要求
			- 由于AWS的设计不可避免的复杂，我们需要找到一种表达力非常强的语言
				- 这种语言应该是高于代码层面
				- 但同时具备精确的语义
				- 同时这种表达力必须包含现实世界的并发和容错
			- 同时又希望它是高投资回报的现成方法
				- 由于希望快速地构建服务，我们需要一种易于学习和应用的语言，避免深奥的概念。
				- 我们也非常想要一个现有的工具生态系统。
		- 我们找到了TLA+
			- 一种形式化规范语言
				- 基于简单离散数学（discrete math）、基本集合理论（basic set theory）、谓词逻辑（predicates）
					- 工程师比较熟悉的概念
			- [[TLA+]]规范描述了一个系统的所有可能的合法行为或执行轨迹。
				- 我们发现用同样的语言来描述期望的系统的正确性特性(“什么”)和系统的设计(“如何”)是很有帮助的。
				- 在TLA+中，正确性属性和系统设计只是抽象阶梯上的一个台阶，其中正确性属性占据较高的层次，系统设计和算法位于中间，可执行代码和硬件位于较低的层次。
				- TLA+的目标是，通过传统的数学推理或TLC模型检查器等工具，尽可能简单地显示系统设计正确地实现了所需的正确性属性
					- TLC模型检查器采用TLA+规范，并在所有可能的执行轨迹上彻底检查所需的正确性属性。
				- 抽象的阶梯也帮助设计师管理现实世界系统的复杂性;
					- 设计人员可以选择在几个抽象的“中间”级别描述系统，每一个较低的级别服务于不同的目的(例如理解细粒度并发的结果或通信介质的更详细的行为)。
					- 然后设计师可以验证每个关卡相对于更高的关卡是否正确。
					- 选择和调整抽象级别的自由使得TLA+非常灵活。
			- 虽然TLA+的语法和习惯用法对程序员来说有些陌生，幸运的是，TLA+还附带了第二种名为PlusCal的语言，它更接近c风格的编程语言，但表现力更强，因为它使用TLA+来表示表达式和值。
				- PlusCal旨在直接替代伪代码。
				- 亚马逊的几位工程师发现，他们使用PlusCal比使用我们的TLA+更有效率。
					- 然而，在其他情况下，TLA+的额外灵活性非常有用。
					- 为了编写丰富的表达式，PlusCal用户必须熟悉TLA+，因为阅读TLA+翻译通常有助于理解一段代码的精确语义。
					- 此外，工具(如TLC模型检查器)工作在TLA+级别。
	- 将形式化方法运用于工业界（Formal Methods for Real-World Systems）
		- 在工业界，形式化方法被经常认为是投入产出比很低的事情，只有在医疗或者航空等安全性要求非常高的场景，才具备合理的投入回报。
		- 但我们使用TLA+的经验告诉我们这是一种偏见
			- 实践情况
				- 在撰写本文时，Amazon工程师已经在10个大型复杂的真实系统上使用了TLA+。
				- 在每一个版本中，TLA+都增加了显著的价值，要么发现了我们确信用其他方法无法发现的微妙bug，要么给了我们足够的理解和信心，让我们在不牺牲正确性的情况下进行积极的性能优化。
				- 在高级管理层和技术领导层的鼓励下，亚马逊现在有7个团队使用TLA+。
			- 上手成本
				- 从初级工程师到首席工程师都能够从头开始学习TLA+，并在两到三周内获得有用的结果，在某些情况下，使用在周末和晚上的个人时间，则无需进一步的帮助或培训。
				- 我们发现，潜在的新用户在开始看教程和示例之前，可以查看目前形式化方法在工业中的实践成果，以获得一些启发。
					- 例如阅读Lamport的教程或网站
	- 一个方面的好处
		- 工程师的常见的系统设计路径
			- 工程师们首先很自然地专注于为一个系统设计“满意的情况”，或者不发生错误的处理路径。这是可以理解的，因为Happy Case是目前最常见的Case。
				- 代码路径必须解决客户的问题——性能良好、有效利用资源，并随业务扩展——所有这些都是它们自身的重大挑战。
			- 当这个Happy Case的设计完成后，工程师会根据个人经验、同事和审稿人的经验，思考“什么地方可能出错”。
				- 然后，工程师根据直觉和偶然发生概率的统计数据，为这些场景添加缓解措施。
				- 通常情况下，工程师在处理“极其罕见”的事件组合时总是会停下来，因为有太多这样的场景可以想象。
		- 相反，当使用形式化方法时
			- 我们从精确地陈述“什么需要做对”开始。
				- 我们首先通过定义正确性属性来指定系统应该做什么，它有两种类型:
					- Safety（安全性）
						- 系统被允许做什么
							- 例如，在任何时候，所有提交的数据都是正确的
							- 例如，系统在任何时候都不能丢失或损坏任何已提交的数据
					- Liveness（活性）
						- 系统最终必须做什么
							- 例如，无论何时系统接收到一个请求，它最终都必须对该请求作出响应。
			- 在定义了正确属性之后，我们接着精确地描述了一个抽象版本的设计，以及它的操作环境的一个抽象版本。
				- 我们通过明确指定系统所依赖的环境的所有属性来表达“什么必须正确”。
					- 例如，“如果通信通道没有失败，那么消息将沿着它传播”，
					- 例如，“如果进程没有重新启动，那么它将保留其本地状态，对任何有意的修改进行模化”。
				- 接下来，为了确认我们的设计正确地处理环境中的所有动态事件，我们指定了每一个可能事件的影响
					- 例如 网络错误和修复、磁盘错误、进程崩溃和重新启动、数据中心故障和修复以及人工操作 的影响。
			- 然后，我们使用 模型检查器 来验证系统在其环境中的规范实现了所选择的正确性属性，尽管操作环境中存在任何事件的组合或交错。
				- 我们发现这种严格的思考“什么需要走对”比特别的思考“什么可能走错”更不容易出错。
	- 另一个方面的好处
		- 我们还发现，在系统的生命周期中，编写形式化规范会带来额外的好处（pays dividends）。
			- （作者用了一个支付股息的比喻，很有意思）
		- 亚马逊所有的生产服务都在不断的发展，即使是几年前发布的;我们增加客户要求的新特性，我们重新设计组件以处理大规模增长，我们通过消除瓶颈来提高性能。
			- 许多这些变化是复杂的，必须在没有停机时间的情况下对运行的系统进行。
			- 我们的首要任务总是避免在生产系统中引起bug，因此我们经常必须回答“这个更改安全吗?”
		- 我们发现，拥有一个精确的、可测试的核心系统模型的一个主要好处是，我们可以在不造成伤害的情况下，迅速验证即使是深层次的变化也是安全的，或者了解到它们是不安全的。
			- 在某些情况下，我们阻止了微妙但严重的bug进入生产环境。
			- 在一些case下，我们已经能够进行创新的性能优化(如消除或缩小消息排序的约束)，但如果没有模型检查这些更改，我们是不敢做的。
		- 一个精确的、可测试的系统描述成为设计的假设工具，就像电子表格成为金融模型的假设工具一样。
			- 我们发现使用这样的工具来探索系统的行为可以提高设计师对系统的理解。
		- 此外，一个精确的、可测试的、评论良好的设计描述是一种优秀的文档形式
			- 这一点很重要，因为AWS系统具有几乎无限的生存周期。
			- 随着时间的推移，团队会随着业务的增长而增长，因此我们必须定期让新人了解系统的最新情况。
				- 这种教育必须是有效的。
				- 为了避免产生细微的错误，我们需要所有的工程师对系统有相同的心智模型，并且这个共享的模型要准确、精确和完整。
			- 工程师们以各种各样的方式形成心智模型——相互交流、阅读设计文件、阅读代码，以及实现错误修复或小特性。
				- 但是讨论和设计文档可能是模糊的或不完整的，而且可执行代码太大，无法快速吸收，而且可能不能准确地反映预期的设计。
			- 相比之下，形式化规范是精确的、简短的，并且可以用工具进行探索和实验。
	- 在AWS的实践中，形式化方法不适用于什么场景
		- 我们关注大型分布式系统的两类主要问题
			- 代码BUG或者运维错误，导致偏离系统原本的逻辑意图;
			- 包含 长链路或者循环反馈 的复杂系统，出现出人意料的“持续涌现的性能退化”
		- 在第一类中，我们知道如何使用形式化规范来发现问题。
		- 然而，第二个类中的问题可能会使系统瘫痪，即使不涉及逻辑错误。
			- 一个常见的例子是服务器短暂的减速(可能是由于Java垃圾收集)导致客户端超时，导致命令行重试请求，从而增加了服务器的负载，并进一步减速。
			- 在这种情况下，系统最终会取得进展;它不会陷入逻辑死锁、活锁或其他循环。
			- 但是从客户的角度来看，由于不可接受的响应时间，它实际上是不可用的。
				- TLA+可以用来指定响应时间的上限，作为一种实时安全属性。
				- 然而，AWS系统是建立在磁盘、操作系统、网络等基础设施上的，不支持硬实时调度或保证，因此实时安全属性是不现实的。
					- 我们建立了软实时系统，其中非常短的慢响应周期不被认为是错误。
					- 然而，长期的严重放缓被认为是错误。
			- 我们还不知道一个可行的方法来模拟一个真实的系统，使工具能够预测这样的突发行为。
				- 所以我们使用其他技术来降低这些风险。
- 形式化方法的实践在AWS的发展历程
	- 形式化方法实践走出的第一步（First Steps to Formal Methods）
		- 这项工作起于 C.N. 对他设计和审查的几个分布式系统的质量的不满，以及对用于构建这些系统的开发过程和工具的不满。
			- 这些系统被认为是成功的，但是BUG和运维问题仍然存在。
				- 为了减轻这些问题，这些系统使用了经过良好验证的方法(生产中普遍使用的契约断言)来检测bug的症状
				- 以及一些机制(比如“面向恢复的计算”) ，试图在bug触发时将影响降到最低。
				- 然而，反应性机制不能从对客户数据造成永久性损害的bug中恢复;相反，我们必须防止这样的错误产生。
		- 在寻找解决方案时，一开始没有选择形式化方法，因为对其投入产出比低的偏见
			- 克服了这种偏见，是由于看到一个实践
				- Zave, P. Using lightweight modeling to understand Chord. ACM SIGCOMM Computer Communication Review 42, 2 (Apr. 2012), 49–57.
				- 它使用一种叫做Alloy的语言在一个叫做Chord的分布式系统的成员协议中找到了严重的bug
			- 但Alloy表现力不够，没法拿来给我们的系统很好的建模
		- 后来找到了TLA+
			- TLA+实际上已运用于经典的Paxos算法，它在工业界还有一些其他的实践，所以给足了我们信心
		- 之后就是说服工程师使用TLA+
	- 第一个巨大的成功案例
		- DynamoDB
			- DynamoDB中的复制和容错机制是由作者T.R.创建的。
			- 为了验证生产代码的正确性，T.R.使用模拟网络层进行了大量的故障注入测试，以控制消息丢失、复制和重编。
				- 该系统还在许多不同的工作负载下在真实硬件上进行了长时间的压力测试。
			- 我们知道这样的测试是绝对必要的，但仍然不能发现设计中的细微缺陷。
				- 为了验证DynamoDB的设计，T.R.写了详细的非正式的正确性证明，确实在设计的早期版本中发现了几个错误。
				- 然而，我们也学到了传统的非正式证明可能忽略非常微妙的问题
				- 为了达到设计的最高水平，T.R.选择了TLA+。
			- T.R.学习了TLA+，并在几周内写了这些组件的详细规范。
				- 模型检查器验证了算法中一小部分复杂的部分在足够大的系统实例中正常工作，从而给出了较高的置信度。
				- 然后检查了更广泛的容错算法。 这一次，模型检查器发现了一个可能导致丢失数据的错误
			- 这个bug已经通过了大量的设计评审、代码评审和测试，并且T.R.相信如果我们还是使用传统的验证方法，是不会发现它的。
	- 如何推广给更多的工程师
		- DynamoDB的成功为我们提供了足够的证据，向亚马逊更广泛的工程社区展示TLA+。
		- 这就提出了一个挑战——如何向软件工程师的听众传达正式方法的目的和好处。
			- 工程师考虑的是调试而不是“验证”，所以我们把演示称为“调试设计”
			- 继续这个比喻，我们发现，如果我们将TLA+称为“完全可测试的伪代码”，软件工程师会更容易理解它的概念和实际价值。
			- 我们最初避免使用“形式”、“验证”和“证明”这些词，因为人们普遍认为形式方法是不切实际的。我们一开始也避免提及TLA代表什么，因为这样做会给人一种好像复杂性很高的印象。
		- 在看到演示之后，S3团队立即请求使用TLA+来验证一种新的容错网络算法。
			- 另外，他们发现使用PlusCal比使用TLA+更有效率
			- 我们观察到，工程师通常认为从PlusCal开始进行形式化方法的实践更容易。
		- 其他的团队也开始使用，发现了一些问题
		- 另外产生了一些其他的实践
			- 亚马逊的工程师继续使用TLA+，采用的做法是首先编写一份传统的散文设计文档，然后逐步将其中的部分内容细化为PlusCal或TLA+。这种方法经常产生关于设计的重要见解，甚至不需要进行完整的规格或模型检查，也可以产生效果。
			- 我们还发现TLA+是一种非常好的数据建模工具
				- 我们使用TLA+设计了一个具有语义不变量的复杂schema，该模式比标准的多重性约束和外键约束丰富得多。
				- 然后，我们添加了数据上的一些主要操作的高级规范，这些规范帮助我们纠正和改进模式。
				- 这个结果表明，数据模型可以被看作是整个系统的另一个抽象级别。
			- TLA+还可以帮助设计者提高系统的可扩展性。
				- 为了消除可伸缩性瓶颈，设计人员经常将原子事务分解为通过异步工作流链接在一起的细粒度操作;
				- TLA+可以帮助探索这些变化在隔离和一致性方面的后果。
	- 工程师最常问的问题（我如何保证我的代码能正确实现 形式化验证的设计）
		- 在学习TLA+时，工程师们通常会问:“我如何保证我的代码能正确实现 形式化验证的设计”
			- 答案是我们不知道。
			- 尽管如此，形式化方法仍然在很多方面提供帮助
				- 得到正确的设计。
					- 形式化方法可以帮助工程师获得正确的设计，这是获得正确代码的必要的第一步。如果设计被破坏了，那么代码几乎肯定会被破坏，因为编码过程中的错误不太可能弥补设计中的错误。更糟糕的是，工程师们很可能会被欺骗，相信代码是“正确的”，因为它似乎正确地实现了(损坏的)设计。工程师在专注于编码时不太可能意识到设计是错误的;
				- 获得更好的理解。
					- 形式化方法帮助工程师更好地理解设计。提高理解只会增加他们获得正确代码的机会;
				- 编写更好的代码。
					- 形式化方法可以帮助工程师以断言的形式编写更好的“自我诊断代码”。
						- 我们自己的经验表明，断言的普遍使用是减少代码错误的好方法。
						- 断言检查整个系统不变量的一小部分局部。
						- 一个好的系统不变量抓住了系统工作的根本原因;
							- 系统不会做任何可能违反安全属性的错误行为，只要它持续保持系统的不变性。
						- 挑战在于找到一个好的系统不变量，一个足够强的系统不变量，以确保不违反任何安全特性。
						- 形式化方法可以帮助工程师找到强不变量，因此形式化方法可以帮助改进有助于提高代码质量的断言。
				- 虽然我们想验证可执行代码是否正确地实现了高级规范，甚至从规范中生成了代码，但我们不知道有任何这样的工具可以处理像亚马逊上构建的那些大型和复杂的分布式系统。
					- 我们确实经常使用传统的静态分析工具，但是它们在很大程度上局限于寻找代码中的“局部”问题，并且无法验证是否符合高级规范。
				- 我们已经看到使用TLC模型检查器在测试代码的设计中寻找“边缘情况”的研究，下面这个似乎是可行的方法。然而，Tasiran等人涵盖了硬件设计，我们还没有尝试将该方法应用于软件。
					- Tasiran, S., Yu, Y., Batson, B., and Kreider, S. Using formal specifications to monitor and guide simulation: Verifying the cache coherence engine of the Alpha 21364 microprocessor. In Proceedings of the Third IEEE International Workshop on Microprocessor Test and Verification (Austin, TX, June). IEEE Computer Society, 2002.
- TLA+的其他替代选择
	- 形式化方法有很多种，这篇文章讲了我们为何选择TLA+，我们有一些自己的约束条件
		- Newcombe, C. Why Amazon chose TLA+. In
		  Proceedings of the Fourth International Conference Lecture Notes in Computer Science Volume 8477, Y.A. Ameur and K.-D. Schewe, Eds. (Toulouse, France, June 2–6). Springer, 2014, 25–39.
- 业界其他相关的工作
	- 见文章
- 结论
	- 形式化方法在AWS上取得了巨大的成功，它帮助我们避免了一些微妙但严重的bug进入生产，这些bug是我们通过其他任何技术都无法发现的。
		- 他们帮助我们在不牺牲质量的情况下设计出复杂算法的积极优化。
	- 在撰写本文时，七个亚马逊团队已经使用了TLA+，他们都发现了这样做的价值，而且更多的亚马逊团队开始使用它。
		- 使用TLA+将提高我们系统的上市时间和质量。
	- 执行管理层积极鼓励团队为新特性和其他重大设计变化编写TLA+规范。
		- 在年度计划中，经理将工程时间分配给TLA+。
	- 虽然我们的结果令人鼓舞，但仍有一些重要的警告。
		- 形式化方法处理的是系统的模型，而不是系统本身，所以“所有的模型都是错误的，有些是有用的”这句格言是适用的。
		- 设计人员必须确保模型捕捉到真实系统的重要方面。
			- 实现它是一种特殊的技能，它的掌握需要深思熟虑的练习。
		- 此外，我们只关心在我们的特定问题上获得实际利益，而没有尝试进行全面的调查。因此，在其他工具或其他问题领域中，使用形式化方法的效果可能会有所不同。