- http://gaul.org/talks/s3fs-tradeoffs/#3
- Why use an S3 file system
	- Need some degree of POSIX application compatibility（需要一定程度的POSIX应用程序兼容性）
		- Interoperate with both cloud-native and legacy applications
	- Store TBs or PBs of data cheaply with good sequential performance (以较低的成本存储TBs或PBs的数据，具有良好的顺序性能)
		- Archival, analytics, and machine learning
	- Lightweight network file system（轻量级网络文件系统）
		- Personal computer or Raspberry Pi
- Trade-offs -- pick two
	- POSIX、Native Object access、Fast
		- ![image.png](../assets/image_1668592301339_0.png){:height 369, :width 423}
- FUSE
	- Filesystem in Userspace
	- Allows non-kernel file system implementations（允许非内核文件系统实现）
	- Maps POSIX system calls to FUSE operations
		- ssize_t write(int fd, void *buf, size_t count)
	- Wide variety: btfs, dbxfs, sshfs, and hundreds more
- S3
	- Amazon Simple Storage Service
	- The most popular object storage protocol
	- Object storage offers scale-out performance and lower costs
	- Many implementations: AWS, Backblaze, Ceph, GCS, Minio, and OpenStack Swift
	- Wide variety of applications and SDKs
- Comparing POSIX and S3 APIs
	- POSIX has stateful files while S3 has stateless objects
		- ![image.png](../assets/image_1668592468167_0.png){:height 325, :width 319}
			- lseek: 用于显式地为一个已打开的文件设置其偏移量
				- S3没有lseek主要意味着追加写入操作比较难实现。而对于读取，则可以由GetObject带上Range: bytes=KK-NN来实现偏移量读取，不过偏移量也需要自己维护。
- s3fs
	- One of the earliest S3 file systems
	- Focus on native S3 object interoperability and POSIX compatibility（关注本地S3对象互操作性和POSIX兼容性）
		- Lacks atomic renames and hard links（缺乏原子重命名和硬链接）
	- Multiple clients can mount a bucket although caching delays updates（多个客户端可以挂载同一个桶，尽管缓存会延迟更新）
	- Lots of configuration knobs (too many?)
	- Many distribution packages: Debian, Red Hat, Ubuntu, FreeBSD, and macOS
- s3fs read example
	- Application calls read with a 128 KB buffer
	- s3fs issues 5 parallel GetObject requests for 10 MB regions
		- GET /foo HTTP/1.1
		- Range: 1-10485760
	- s3fs returns 128 KB to the client and caches the data for future reads
	- Performance is good for larger files
- s3fs write new file example
	- Application calls write
	- s3fs writes data to the local disk
	- s3fs flushes on close, fsync, or when more than 5 GB written
		- Issue CreateMultipartUpload
		- Issue multiple UploadPart to write modified data
		- Issue CompleteMultipartUpload
	- Performance is good when creating larger files
- s3fs write to existing file example
	- During flush s3fs will
		- Evaluate modified data for modified regions smaller than 5 MB
		- Issue GetObject to round up to minimum 5 MB size
		- Issue CreateMultipartUpload
		- Issue UploadPart for modified data
		- Issue UploadPartCopy for unmodified data
		- Issue CompleteMultipartUpload
	- Poor performance with random writes
		- One byte write requires several RPCs and O(file size) server-side IO!
- s3fs readdir example
	- Application calls getdents
	- s3fs issues ListObjects
		- Returns basic information like name, size, and modified time
	- s3fs issues parallel HeadObject requests for each file
		- Returns extended information like access & change time, owner, permissions, etc.
	- s3fs returns struct dirent
	- Terrible performance: one system call can turn into thousands of HTTP requests!
- s3fs caching
	- s3fs works around poor performance with a variety of caches
	- Stat cache: holds file metadata
		- Defaults to 100,000 entries cached for 15 minutes
	- Noobj cache: holds negative directory entries
	- Data cache: holds file read data
	- Only enables stat cache by default
- goofys
	- Focus on performance and large files
	- Simpler mapping from POSIX to S3 than s3fs
	- Does not support atomic renames, random writes, fsync, hard links, and symlinks
	- Fakes some metadata - atime/ctime, uid/gid, and permissions
	- Lacks native data cache but integrates with external catfs（缺乏本地数据缓存，但与外部catfs集成）
	- Sane defaults - fewer configuration knobs than s3fs
- goofys write new file example
	- Application calls write
		- goofys buffers in memory
	- goofys flushes when more than 5 MB written
		- Asynchronously issue UploadPart to write buffered data
	- Application calls close
		- goofys synchronously issues CompleteMultipartUpload
	-